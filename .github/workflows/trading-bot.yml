name: Trading Bot - Analyse horaire

on:
  schedule:
    # Ex√©cution toutes les heures (√† la minute 5)
    - cron: '*/5 * * * *'

  # Permet aussi le d√©clenchement manuel
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üêç Configuration Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Installation des d√©pendances
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # R√©cup√©ration de l'√©tat pr√©c√©dent (s'il existe)
      - name: üìÇ T√©l√©chargement de l'√©tat pr√©c√©dent
        uses: actions/cache@v4
        with:
          path: state.json
          key: bot-state-${{ github.run_id }}
          restore-keys: |
            bot-state-

      - name: ü§ñ Ex√©cution du bot
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_HEARTBEAT_WEBHOOK_URL: ${{ secrets.DISCORD_HEARTBEAT_WEBHOOK_URL }}
          SYMBOL: 'BTC/USDT'
          TIMEFRAME: '1h'
          SEND_HEARTBEAT: 'true'
          EXCHANGE: 'kraken'
          DATA_LIMIT: '500'
          VOLUME_RATIO_MIN: '0.80'
          VOLUME_SPIKE_MIN: '1.40'
          CHOP_NO_TRADE_MAX: '55'
          ATR_PCT_MIN: '0.0045'
          ATR_EXTREME_MULT: '3.0'
          RSI_MIN: '38'
          RSI_MAX: '62'
          ATR_STOP_MULT: '2.0'
          TP1_MULT: '1.85'
          TP2_MULT: '3.3'
          COOLDOWN_BARS: '16'
          COOLDOWN_BARS_SL: '22'
          TIME_STOP_BARS: '28'
          INITIAL_CAPITAL: '100'
          FEE_RATE: '0.0004'
          SLIPPAGE_BPS: '0.0002'
          HIST_EXCHANGE: 'binance'
          START_DATE: '2023-01-01'
          WARMUP_BARS: '220'
          LONG_ONLY: 'false'
          PLOT_TRADES: 'true'
          PLOT_DAYS: '60'
          PLOT_PATH: 'backtest_plot.png'
          PLOT_LABEL_TRADES: 'false'
          TEST_MODE: 'false'
          REQUIRE_STRUCTURE: 'false'
          REQUIRE_VWAP: 'false'
          REQUIRE_MACD: 'false'
          REQUIRE_VOLUME_SPIKE: 'true'
        run: |
          echo "üöÄ D√©marrage de l'analyse..."
          python main.py
          echo "‚úÖ Analyse termin√©e"

      # Sauvegarde du nouvel √©tat
      - name: üíæ Sauvegarde de l'√©tat
        uses: actions/cache/save@v4
        if: always()
        with:
          path: state.json
          key: bot-state-${{ github.run_id }}